// ==UserScript==
// @name         ğŸ§  LEARNING AI SIDEBAR v8.0 (ğŸ‘ğŸ‘ Training!)
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';
    GM_addStyle(`#ai-panel{position:fixed;top:60px;right:0;z-index:10000;background:linear-gradient(135deg,#020024,#090979,#ff6ac1);backdrop-filter:blur(20px);border-radius:24px 0 0 24px;box-shadow:0 25px 50px rgba(0,0,0,0.5);width:280px;height:calc(100vh-80px);font-family:-apple-system,sans-serif;transition:all 0.3s;pointer-events:auto;}.ai-header{padding:20px;color:white;background:rgba(0,0,0,0.4);cursor:move;}.ai-title{font-size:18px;font-weight:700;margin:0;}.ai-content{padding:18px;background:rgba(5,10,30,0.95);height:calc(100%-64px);overflow:auto;color:#e5e7eb;}.preset-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px;}.preset-btn{padding:12px;background:rgba(15,23,42,0.9);border:2px solid #94a3b8;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.25s;color:#e5e7eb;}.preset-btn:hover{background:#4f46e5;color:white;}.preset-btn.active{background:linear-gradient(135deg,#4f46e5,#ec4899);color:white;}.ai-btn{width:100%;padding:12px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;margin:4px 0;transition:all 0.25s;}.ai-btn:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(34,197,94,0.4);}.ai-btn:disabled{opacity:0.6;cursor:not-allowed;}.ai-result{background:rgba(15,23,42,0.95);border-radius:14px;padding:16px;font-size:13px;line-height:1.7;white-space:pre-wrap;border-left:4px solid #22c55e;margin-top:12px;display:none;color:#e5e7eb;}.status{padding:8px;border-radius:10px;margin:8px 0;font-size:12px;text-align:center;}.status.success{background:rgba(22,163,74,0.2);color:#bbf7d0;border:1px solid #22c55e;}.status.error{background:rgba(220,38,38,0.2);color:#fecaca;border:1px solid #f87171;}.feedback-btns{display:flex;gap:8px;margin:12px 0;}.feedback-btn{padding:8px;font-size:14px;border-radius:8px;flex:1;font-weight:600;transition:all 0.2s;}.good{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;}.bad{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;}.good:hover{box-shadow:0 8px 20px rgba(34,197,94,0.4);}.bad:hover{box-shadow:0 8px 20px rgba(239,68,68,0.4);}`);
    
    const panel=document.createElement('div');panel.id='ai-panel';panel.innerHTML=`<div class="ai-header"><h2 class="ai-title">ğŸ§  LEARNING AI (Train Me!)</h2></div><div class="ai-content"><div class="preset-grid"><button class="preset-btn active" data-command="Summarize this page">ğŸ“ Summary</button><button class="preset-btn" data-command="Extract key points">ğŸ”¹ Key Points</button><button class="preset-btn" data-command="Find top items">â­ Top Items</button><button class="preset-btn" data-command="Analyze insights">ğŸ’¡ Insights</button><button class="preset-btn" data-command="Show structure">ğŸ“Š Structure</button></div><input type="text" class="ai-input" id="ai-command" placeholder="Custom..."><button class="ai-btn" id="ai-run">ğŸš€ Analyze</button><div id="status"></div><div id="ai-result"></div><div class="feedback-btns"><button class="feedback-btn good" id="good">ğŸ‘ GOOD</button><button class="feedback-btn bad" id="bad">ğŸ‘ WRONG</button></div></div>`;document.body.appendChild(panel);
    
    const commandInput=document.getElementById('ai-command'),runBtn=document.getElementById('ai-run'),resultDiv=document.getElementById('ai-result'),statusDiv=document.getElementById('status'),presets=panel.querySelectorAll('.preset-btn'),goodBtn=document.getElementById('good'),badBtn=document.getElementById('bad'),pageContent=window.location.href;
    let lastCommand='',lastResult='';
    
    function showStatus(msg,type){statusDiv.innerHTML=`<div class="status ${type}">${msg}</div>`;}
    function setPreset(btn){commandInput.value=btn.dataset.command;presets.forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
    
    async function runAI(){const command=commandInput.value.trim();if(!command)return showStatus('Pick preset!','error');runBtn.disabled=true;runBtn.textContent='ğŸ¤– AI...';showStatus('Analyzing...','success');try{const response=await new Promise((r,j)=>{GM_xmlhttpRequest({method:'POST',url:'http://localhost:5000/analyze',headers:{'Content-Type':'application/json'},data:JSON.stringify({url:pageContent,command}),timeout:10000,onload:res=>{try{r(JSON.parse(res.responseText))}catch(e){j('Server error')}},onerror:()=>j('Server offline'),ontimeout:()=>j('Timeout')})});lastCommand=command;lastResult=response.result;resultDiv.innerHTML=`<div style="font-weight:700;color:#bfdbfe;margin-bottom:10px;">${command}</div><div style="white-space:pre-wrap;line-height:1.6;">${response.result}</div>`;resultDiv.style.display='block';showStatus('âœ… Done! ğŸ‘ğŸ‘ to teach me!','success');}catch(e){showStatus(e,'error')}finally{runBtn.disabled=false;runBtn.textContent='ğŸš€ Analyze';}}
    
    async function teachAI(isGood){if(!lastCommand||!lastResult)return;const types={summary:0,'key points':1,'top items':2,insights:3,structure:4},typeNum=types[lastCommand.toLowerCase().includes('summary')?'summary':lastCommand.toLowerCase().includes('key')?'key points':lastCommand.toLowerCase().includes('top')?'top items':lastCommand.toLowerCase().includes('insight')?'insights':'structure'];try{await new Promise((r,j)=>{GM_xmlhttpRequest({method:'POST',url:'http://localhost:5001/learn',headers:{'Content-Type':'application/json'},data:JSON.stringify({page_content:pageContent,command:lastCommand,correct_type:isGood?typeNum:1-typeNum}),timeout:5000,onload:res=>r(JSON.parse(res.responseText)),onerror:j,ontimeout:j})});showStatus(isGood?'ğŸ‰ LEARNED CORRECT!':'ğŸ”„ LEARNED CORRECTION!','success');}catch(e){showStatus('Learning failed','error')}}
    
    presets.forEach(btn=>btn.addEventListener('click',()=>setPreset(btn)));runBtn.addEventListener('click',runAI);goodBtn.addEventListener('click',()=>teachAI(true));badBtn.addEventListener('click',()=>teachAI(false));commandInput.addEventListener('keypress',e=>e.key==='Enter'&&runAI());
    console.log('ğŸ§  LEARNING AI v8.0 ACTIVE!');
})();
